<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Mali OpenGL ES SDK v2.4.0: Particle System Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="top_banner.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Mali OpenGL ES SDK v2.4.0
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li class="current"><a href="pages.html"><span>Help&#160;and&#160;Tutorials</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('particle_system_tutorial.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Particle System Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A sample which shows how to create and draw a particle system to simulate smoke.</p>
<p>This tutorial is split into the following sections:</p>
<ol type="1">
<li><a class="el" href="particle_system_tutorial.html#particleSystemOverview">Particle System Overview</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemEmitter">The emitter</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemPlatform">Set up Platform object</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemEGL">Set up EGL.</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemOpenGL_ES">Set up OpenGL ES environment</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemShaderPrograms">Setup vertex and fragment shaders</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemRenderFrame">Code to draw a single frame</a></li>
<li><a class="el" href="particle_system_tutorial.html#particleSystemReleaseResources">Release allocated resources</a></li>
</ol>
<h1><a class="anchor" id="psWalkthrough"></a>
Walkthrough</h1>
<h2><a class="anchor" id="particleSystemOverview"></a>
Particle System Overview</h2>
<p>In Computer Graphics the term particle system refers to a technique that makes use of a large number of very small sprites or other graphic objects to simulate chaotic systems, natural phenomena and other processes which are otherwise very hard to reproduce with conventional rendering techniques. Usually phenomena such as fire, explosions, smoke, fog, snow, dust, etc, are graphically simulated using particle systems. Typically in a particle system there are three stages: particle creation, simulation and rendering.</p>
<p>Particle creation is governed by what is referred as an emitter. The emitter is the source of particles and its location in the 3D space defines where particle are generated and their properties or behaviour parameters. Parameters can include any relevant property or magnitude such as colour, mass, initial velocity vector, particle lifetime, etc. Usually these parameters are random numbers in a given interval.</p>
<p>Once particles are created we need to update their position in the space as time passes as well as any other time-dependent parameter, velocity, acceleration, colour, etc. This is what is known as simulation and where physics' Laws of Motion are considered to take into account the influence of any external force such as gravity, wind, friction, etc. Usually collision detection of particles with other relevant objects is considered but not the collision between the particles themselves as it can be really computationally expensive. At this stage all particles are also checked to see if they have exceeded their lifetime, in which case they are removed from the simulation.</p>
<p>Finally we need to render each particle after the update is complete. Typically each particle has a partially transparent associated texture (in many cases animated for better realism) mapped onto a plane that is always oriented to camera, known as sprite. Nevertheless particles can be also rendered simply as a point.</p>
<p>Particle simulation and rendering is performed in every frame of animation.</p>
<p>The current tutorial implements a simple particle system to simulate smoke.</p>
<h2><a class="anchor" id="particleSystemEmitter"></a>
The emitter</h2>
<p>The emitter is implemented in the class DiscEmitter. By default the emitter creates particles within a region defined by a circle of unitary diameter with a velocity vector in a direction of positive Z axis with an azimuth angle in the interval [0, pi/10] and unitary length. Other particle's parameters are lifetime and delay. The delay parameter is used to avoid all particles be emitted at the same time when the program starts.</p>
<p>Particle generation is performed by requesting the DiscEmitter object for a particle. Particle parameters are create using pseudo random numbers obtained by means of rand() function.</p>
<div class="fragment"><div class="line">    <span class="keywordtype">void</span> DiscEmitter::getParticle(Particle &amp;part)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Generate  a random number in the interval [0,1]. */</span></div>
<div class="line">        <span class="keywordtype">float</span> rad = (<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)rand()/((<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)RAND_MAX);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Generate  a random number in the interval [0,1]. */</span></div>
<div class="line">        <span class="keywordtype">float</span> polarAngle = (<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)rand()/((<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)RAND_MAX);</div>
<div class="line">        polarAngle *= 2 * <a class="code" href="_mathematics_8h.html#ae71449b1cc6e6250b91f539153a7a0d3" title="The value of pi.">M_PI</a>;</div>
<div class="line"></div>
<div class="line">        part.initPos.x = discRadius * rad * cos(polarAngle);</div>
<div class="line">        part.initPos.y = discRadius * rad * sin(polarAngle);</div>
<div class="line">        part.initPos.z = 0.0f;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Generate  a random number in the interval [0,1]. */</span></div>
<div class="line">        <span class="keywordtype">float</span> azimuthAngle = (<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)rand()/((<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)RAND_MAX);</div>
<div class="line">        azimuthAngle *= maxEmissionAngle;</div>
<div class="line"></div>
<div class="line">        part.initVel.x = sin(azimuthAngle) * cos(polarAngle);</div>
<div class="line">        part.initVel.y = sin(azimuthAngle) * sin(polarAngle);</div>
<div class="line">        part.initVel.z = cos(azimuthAngle);</div>
<div class="line"></div>
<div class="line">        part.lifetime = (<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)rand()/((<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)RAND_MAX);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Generate  a random number in the interval [0,1]. */</span></div>
<div class="line">        part.delay = (<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)rand()/((<a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>)RAND_MAX);</div>
<div class="line"></div>
<div class="line">    }</div>
</div><!-- fragment --> <h2><a class="anchor" id="particleSystemPlatform"></a>
Set up Platform object</h2>
<p><a class="el" href="_particle_system_8cpp.html" title="A sample which shows how to create and draw a particle system.">ParticleSystem.cpp</a> uses the Platform class in simple-framework.lib library to hide the complexity of multiple build targets.</p>
<ol type="1">
<li><p class="startli"><b>Intialize the Platform object</b></p>
<p class="startli">Intialize the Platform object for platform specific functions: </p>
<div class="fragment"><div class="line">    <span class="comment">/* Initialize the Platform object for platform specific functions. */</span></div>
<div class="line">    Platform *platform = Platform::getInstance();</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Initialize the window system</b></p>
<p class="startli">Create and initialize the window system: </p>
<div class="fragment"><div class="line">    <span class="comment">/* Initialize windowing system. */</span></div>
<div class="line">    platform-&gt;createWindow(<a class="code" href="_anti_alias_8cpp.html#a8798173d5ef65c83d1db3288a6bc23bb">WINDOW_W</a>, <a class="code" href="_anti_alias_8cpp.html#ac99e9b1c151b601470732c2c9ff9866f">WINDOW_H</a>);</div>
</div><!-- fragment --> </li>
</ol>
<h2><a class="anchor" id="particleSystemEGL"></a>
Set up EGL.</h2>
<p>Initialize the interface between OpenGL ES and the underlying native platform window and bind the context to the current rendering thread and to the draw and read surfaces. </p>
<div class="fragment"><div class="line">    <span class="comment">/* Initialize EGL. */</span></div>
<div class="line">    EGLRuntime::initializeEGL(EGLRuntime::OPENGLES2);</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_e_g_l_runtime_8h.html#a43f2e753de422d9710dad9e21b4e9fff">EGL_CHECK</a>(eglMakeCurrent(EGLRuntime::display, EGLRuntime::surface, EGLRuntime::surface, EGLRuntime::context));</div>
</div><!-- fragment --> <h2><a class="anchor" id="particleSystemOpenGL_ES"></a>
Set up OpenGL ES environment</h2>
<p>Initialize OpenGL ES environment by calling appropriate OpenGL ES API functions. Initialization calls are gathered in setupGraphics function which receives the width and height of the graphic window.</p>
<p>As the function setupGraphics is called only once it is a good place to create here the userData structure that will hold all working data.</p>
<div class="fragment"><div class="line">    <span class="comment">/* Create structure to hold all data. */</span></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a> = <span class="keyword">new</span> <a class="code" href="struct_user_data.html">UserData</a>;</div>
</div><!-- fragment --><p> After that, the path to vertex and fragment shader files are defined and references to vertex and fragment program objects are declared and initialized to zero.</p>
<div class="fragment"><div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;setupGraphics(%d, %d)&quot;</span>, width, height);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Full paths to the shader and texture files. */</span></div>
<div class="line">    <span class="keywordtype">string</span> <a class="code" href="_boids_8cpp.html#a47b65663f76b84243e94a330406064ea">vertexShaderPath</a> = <a class="code" href="_anti_alias_8cpp.html#af3c44c0c93c88997d3c0fe7e034bcc54">resourceDirectory</a> + <a class="code" href="_anti_alias_8cpp.html#a8588b29cab2c2e9095e12aaeb73fb134">vertexShaderFilename</a>;</div>
<div class="line">    <span class="keywordtype">string</span> <a class="code" href="_boids_8cpp.html#a901e17b6a7b10cfecc5aa66a02266ad6">fragmentShaderPath</a> = <a class="code" href="_anti_alias_8cpp.html#af3c44c0c93c88997d3c0fe7e034bcc54">resourceDirectory</a> + <a class="code" href="_anti_alias_8cpp.html#aa8eb3ce1f38404f66445f5a325ad5b9c">fragmentShaderFilename</a>;</div>
<div class="line">    <span class="keywordtype">string</span> texturePath = <a class="code" href="_anti_alias_8cpp.html#af3c44c0c93c88997d3c0fe7e034bcc54">resourceDirectory</a> + <a class="code" href="_e_t_c_atlas_alpha_8cpp.html#a0ba7495bec472f35ce7dfed65ef25422">textureFilename</a>;</div>
<div class="line"></div>
<div class="line">    GLuint <a class="code" href="_e_t_c_compressed_alpha_8cpp.html#a553ff6401f1eda6d3d25bc99de212219">vertexShaderID</a> = 0;</div>
<div class="line">    GLuint <a class="code" href="_e_t_c_compressed_alpha_8cpp.html#a2c9f2b6397750a741c6ea1cb92c6c586">fragmentShaderID</a> = 0;</div>
</div><!-- fragment --><p> Next some OpenGL ES initialization is performed. </p>
<div class="fragment"><div class="line">    <span class="comment">/* Initialize OpenGL ES */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glEnable(GL_BLEND));</div>
<div class="line">    <span class="comment">/* Alpha blending. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initialize the Text object and add some text. */</span></div>
<div class="line">    <a class="code" href="_anti_alias_8cpp.html#a40f21880bfa32eac92ee5cc4873898ef">text</a> = <span class="keyword">new</span> Text(<a class="code" href="_anti_alias_8cpp.html#af3c44c0c93c88997d3c0fe7e034bcc54">resourceDirectory</a>.c_str(), width, height);</div>
<div class="line">    <span class="keywordtype">char</span> buffer [50];</div>
<div class="line">    sprintf (buffer, <span class="stringliteral">&quot;Simple Particle System: %d particles&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a75cbc112dce4b21c13fe7bb671accab1">NUM_PARTICLES</a>);</div>
<div class="line">    <a class="code" href="_anti_alias_8cpp.html#a40f21880bfa32eac92ee5cc4873898ef">text</a>-&gt;addString(10, 10, buffer, 255, 255, 0, 255);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a7a435531662e61eed27859a7d96d8734">initialiseTextureFromRawGreyscaleAlphaFile</a>(texturePath);</div>
<div class="line"></div>
</div><!-- fragment --><p> The first two commands tell OpenGL ES to activate alpha blending and how we want this blending to occur. Blending is OpenGL ES's mechanism for combining color already in the framebuffer with the color of the incoming primitive. The result of this combination is then stored back in the framebuffer. Blending is frequently used to simulate translucent physical materials.</p>
<p>Alpha blending is used for rendering particle sprites and also for drawing the text "Simple particle system" which is drawn at the bottom of the window. The text, its colour and position are defined in the next two commands of the code snippet.</p>
<p>In the final line a call to the function initialiseTextureFromRawGreyscaleAlphaFile is performed to load and initialize the texture used in the particle sprites.</p>
<p>The next step is to process the shaders. Shader codes need to be loaded, compiled and linked.</p>
<div class="fragment"><div class="line">    <span class="comment">/* Process shaders. */</span></div>
<div class="line">    Shader::processShader(&amp;vertexShaderID, vertexShaderPath.c_str(), GL_VERTEX_SHADER);</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;vertexShaderID = %d&quot;</span>, vertexShaderID);</div>
<div class="line">    Shader::processShader(&amp;fragmentShaderID, fragmentShaderPath.c_str(), GL_FRAGMENT_SHADER);</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;fragmentShaderID = %d&quot;</span>, fragmentShaderID);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a> = <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glCreateProgram());</div>
<div class="line"></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glAttachShader(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, vertexShaderID));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glAttachShader(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, fragmentShaderID));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glLinkProgram(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUseProgram(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>));</div>
</div><!-- fragment --><p> The library function Shader::processShader performs internally several operations. It creates a shader object, loads the shader code from the file and compiles it. This function is called twice: for the vertex and the fragment shaders.</p>
<p>The next lines create a container for the program, attach to it the already compiled shaders, link them together in the program and tell OpenGL ES to make the executable part of the current rendering state by invoking glUseProgram.</p>
<p>We can create as many programs as we want. When rendering, we can switch from program to program in a single frame. For example, you may want to draw an sphere with a reflection shader, while having a cube map displayed as background using another shader.</p>
<p>Multiple shader objects of the same type may not be attached to a single program object. However, a single shader object may be attached to more than one program object.</p>
<p>Following this all particles are initialized. </p>
<div class="fragment"><div class="line">    <a class="code" href="_particle_system_8cpp.html#ad5f02f23e83ec5d1ff75a45300697ec5">initializeParticleDataArray</a>();</div>
</div><!-- fragment --><p> In the <a class="el" href="_particle_system_8cpp.html#ad5f02f23e83ec5d1ff75a45300697ec5">initializeParticleDataArray()</a> function an emitter object is created and requested NUM_PARTICLES times to create the particles. Each particle data is stored in the userData-&gt;particleData arrray.</p>
<p>Next step is to retrieve the location of the vertex attribute variables defined in the shader code and the sampler used in the fragment shader.</p>
<div class="fragment"><div class="line">    <span class="comment">/* Get attribute locations. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#acea29a45f77f8d4386c6a46f21529563">iLocPosition</a> = glGetAttribLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;a_v3Position&quot;</span>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;glGetAttribLocation(\&quot;a_v3Position\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#acea29a45f77f8d4386c6a46f21529563">iLocPosition</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a2a26c1dd1d791cfb3967d3b910343fff">iLocVelocity</a> = glGetAttribLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;a_v3Velocity&quot;</span>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;glGetAttribLocation(\&quot;a_v3Velocity\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a2a26c1dd1d791cfb3967d3b910343fff">iLocVelocity</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a7d89b3622b7d7e3152cc98ff83c1f34a">iLocParticleTimes</a> = glGetAttribLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;a_v3ParticleTimes&quot;</span>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;glGetAttribLocation(\&quot;a_v3ParticleTimes\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a7d89b3622b7d7e3152cc98ff83c1f34a">iLocParticleTimes</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Get uniform locations. */</span></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#abff8871ff9ca5f27e4a788b27c083544">iLocMVP</a> = <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glGetUniformLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;mvp&quot;</span>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;glGetUniformLocation(\&quot;mvp\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#abff8871ff9ca5f27e4a788b27c083544">iLocMVP</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a75854fa76c5c2c81d908608710a60689">iLocGravity</a> = <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glGetUniformLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;u_v3gravity&quot;</span>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;glGetUniformLocation(\&quot;u_v3gravity\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a75854fa76c5c2c81d908608710a60689">iLocGravity</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a8cd725c4a2ded36ab49d05df6d672038">iLocSampler</a> = <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glGetUniformLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;s_texture&quot;</span>));</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a8cd725c4a2ded36ab49d05df6d672038">iLocSampler</a> == -1)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;Warning: glGetUniformLocation(\&quot;s_texture\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a8cd725c4a2ded36ab49d05df6d672038">iLocSampler</a>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUniform1i(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a8cd725c4a2ded36ab49d05df6d672038">iLocSampler</a>, 0));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#afbf1e13c677015e5a01e60d1abe89e25">iLocColour</a> = <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glGetUniformLocation(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>, <span class="stringliteral">&quot;u_v3colour&quot;</span>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a62b5282578b939fd77b7bb1d00c4f15a">LOGD</a>(<span class="stringliteral">&quot;glGetUniformLocation(\&quot;u_v3colour\&quot;) = %d\n&quot;</span>, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#afbf1e13c677015e5a01e60d1abe89e25">iLocColour</a>);</div>
</div><!-- fragment --><p> This is the way we can reference them later in the code. As shader code is executed in the GPU we need some way to pass data from CPU code to GPU code as we will see later.</p>
<p>Finally some graphic viewport initialization takes place.</p>
<div class="fragment"><div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glViewport(0, 0, width, height));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set clear screen color. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glClearColor(0.0f, 0.0f, 0.0f, 1.0f));</div>
</div><!-- fragment --><p>The glViewport command tells OpenGL ES the position and size of viewport rectangle.</p>
<p>The glClearColor specifies the RGBA color components values used to initialize the color elements of every pixel whenever the context's frame buffer is cleared.</p>
<h2><a class="anchor" id="particleSystemShaderPrograms"></a>
Setup vertex and fragment shaders</h2>
<p>Shaders define the code to be executed in the GPU. Shaders do not have access to the application's main memory. Any data that a shader needs to do its job has to be specifically sent over to the GPU from the application code. Sending this data incurs overhead and can be a bottleneck in the rendering pipeline. In order to keep rendering performance up, it is important to send only the data that shaders really need. There are two types of data that can be sent from the application code to the shaders: attributes and uniforms.</p>
<p>An attribute is a data associated to each vertex. Each time the vertex shader runs, the pipeline will provide it with just the value that corresponds to the vertex that the shader is executing for. Attributes are available only in the vertex shader.</p>
<p>Uniforms are the second kind of data that can be passed from the application code to the shaders. Uniforms are available to both vertex and fragment shaders. The value of a uniform cannot be changed by the shaders.</p>
<p><b>Vertex shader</b></p>
<p>Below is the code defined in the vertex shader. Vertex shaders implement a general purpose programmable method for operating on vertices. This code is executed in the GPU for every vertex of the triangle.</p>
<div class="fragment"><div class="line">attribute vec3 <a class="code" href="_particle__system_8vert.html#a4f8e5ebde5458fbeee38d7e148d59f86">a_v3Position</a>;</div>
<div class="line">attribute vec3 <a class="code" href="_particle__system_8vert.html#a28845845a65bfcb9d3dc4b67375330c8">a_v3Velocity</a>;</div>
<div class="line">attribute vec3 <a class="code" href="_particle__system_8vert.html#a4f84481ef98667c4bc3fc1cc20a6d982">a_v3ParticleTimes</a>;</div>
<div class="line">uniform mat4 <a class="code" href="_cube__cube_8vert.html#a501d2d6650cfb589aa8960fa429ddb5c">mvp</a>;</div>
<div class="line">uniform vec3 <a class="code" href="_particle__system_8vert.html#a91d5dd58904143c176fd4293d6f35dc8">u_v3gravity</a>;</div>
<div class="line">uniform vec3 <a class="code" href="_particle__system_8vert.html#ab7c29ed8b201bfa282548641b1be8226">u_v3colour</a>;</div>
<div class="line"></div>
<div class="line">varying <span class="keywordtype">float</span> <a class="code" href="_particle__system_8frag.html#a66dc0d65fb6e2516f90c98c59fcb35e9">v_ageFactor</a>;</div>
<div class="line">varying vec3 <a class="code" href="_particle__system_8frag.html#a29e46c11d1682e5d90a283aedb66b5bf">v_v3colour</a>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>()</div>
<div class="line">{</div>
<div class="line">    vec3 newPos;</div>
<div class="line">    <span class="keywordtype">float</span> ageFactor;</div>
<div class="line">    <span class="keywordtype">float</span> delay    = a_v3ParticleTimes.x;</div>
<div class="line">    <span class="keywordtype">float</span> lifetime = a_v3ParticleTimes.y;</div>
<div class="line">    <span class="keywordtype">float</span> age      = a_v3ParticleTimes.z;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( age  &gt; delay )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> t = age - delay;</div>
<div class="line">        <span class="comment">/* Particle motion equation. */</span></div>
<div class="line">        newPos = a_v3Position + a_v3Velocity * t + 0.5 * u_v3gravity * t * t;</div>
<div class="line"></div>
<div class="line">        ageFactor = 1.0 - (age / lifetime);</div>
<div class="line">        ageFactor = clamp(ageFactor, 0.0, 1.0);</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* The older the particle the smaller its size. */</span></div>
<div class="line">        gl_PointSize = ageFactor * 250.0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        newPos = <a class="code" href="_particle__system_8vert.html#a4f8e5ebde5458fbeee38d7e148d59f86">a_v3Position</a>;</div>
<div class="line">        <span class="comment">/* If null size particle will not be drawn. */</span></div>
<div class="line">        gl_PointSize = 0.0;</div>
<div class="line">        ageFactor = 0.0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Initializing varying. */</span></div>
<div class="line">    v_ageFactor = ageFactor;</div>
<div class="line">    v_v3colour = <a class="code" href="_particle__system_8vert.html#ab7c29ed8b201bfa282548641b1be8226">u_v3colour</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Particle position. */</span></div>
<div class="line">    gl_Position.xyz = newPos;</div>
<div class="line">    gl_Position.w = 1.0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Apply matrix transformation. */</span></div>
<div class="line">    gl_Position = mvp * gl_Position;</div>
<div class="line">}</div>
</div><!-- fragment --><p> The lines above main function are simple variable declarations. We have three variables of attribute type which define the particle's coordinates, velocity and a vector containing different time variables. The other three variables of uniform type are passed to the shader from the application code.</p>
<p>The outputs of the vertex shader are called varyings. Varyings are the way to pass data from the vertex shader to the fragment shader. As we need to pass ageFactor and the particle base color to the fragment shader we declare v_ageFactor and v_v3colour as varying type and fill them in the shader code.</p>
<p>The vertex shader checks first if the particle's age is greater than its delay time, i.e. if the particle is flying. In this case the particle position is updated using the formula for uniformly accelerated motion. Additionally the age factor is calculated. The edge factor is used to control the value of gl_PointSize. The variable gl_PointSize is a built in variable that indicates the size in pixels of the point to be rasterized. The older the particle the smaller its size.</p>
<p>The variable glPosition is also a built in, four vector component variable indicating the homogeneous vertex coordinates (x, y, z, w) and must be always filled by the vertex shader.</p>
<p><b>Fragment shader</b></p>
<p>Below is the code defined in the fragment shader. Fragment shaders implement a general purpose programmable method for operating on fragments. This code is executed in the GPU for every fragment after the vertices are processed by the vertex shader followed by the primitive assembly and rasterization stages.</p>
<div class="fragment"><div class="line">precision mediump <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#a74fe015ec452ae5dc48201a6e992f7a1">float</a>;</div>
<div class="line"></div>
<div class="line">varying <span class="keywordtype">float</span> <a class="code" href="_particle__system_8frag.html#a66dc0d65fb6e2516f90c98c59fcb35e9">v_ageFactor</a>;</div>
<div class="line">varying vec3 <a class="code" href="_particle__system_8frag.html#a29e46c11d1682e5d90a283aedb66b5bf">v_v3colour</a>;</div>
<div class="line">uniform sampler2D <a class="code" href="_particle__system_8frag.html#a3b62f5b41473315839c5a567d65855a1">s_texture</a>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="simple__framework_2fonts_2opengles__20_2font_8frag.html#acdef7a1fd863a6d3770c1268cb06add3">main</a>()</div>
<div class="line">{</div>
<div class="line">    vec4 texColour;</div>
<div class="line">    vec2 texCoords;</div>
<div class="line">    <span class="keywordtype">float</span> alphaFactor;</div>
<div class="line"></div>
<div class="line">    texCoords = vec2(gl_PointCoord.x, gl_PointCoord.y);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Define an alpha modulation factor depending of the particle&#39;s age. */</span></div>
<div class="line">    <span class="keywordflow">if</span>(v_ageFactor  &lt;= 0.5)</div>
<div class="line">    {</div>
<div class="line">        alphaFactor = 0.14 * <a class="code" href="_particle__system_8frag.html#a66dc0d65fb6e2516f90c98c59fcb35e9">v_ageFactor</a>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        alphaFactor = -0.14 * v_ageFactor + 0.14;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    vec4 baseColour = vec4(v_v3colour.x, v_v3colour.y, v_v3colour.z, 1.0);</div>
<div class="line">    texColour = texture2D(s_texture, texCoords);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Modulate alpha component. */</span></div>
<div class="line">    texColour.a =  texColour.r * alphaFactor;</div>
<div class="line"></div>
<div class="line">    gl_FragColor = vec4(texColour.r, texColour.r, texColour.r, texColour.a) * baseColour;</div>
<div class="line">}</div>
</div><!-- fragment --><p> The first line of the code sets the default precision qualifier.</p>
<p>The next three lines are simple declaration for varyings received from the vertex shader to be used in the shader code.</p>
<p>The program calculates an alphaFactor according to the value of the age factor. When the particle is very young or very old it is more transparent.</p>
<p>In the next step the value of gl_PointCoord is used to draw a textured point sprite where the transparency value is modulated by the previous calculated alphaFactor.</p>
<p>The final fragment color gl_FragColor is also modulated by the base color passed from the vertex shader.</p>
<h2><a class="anchor" id="particleSystemRenderFrame"></a>
Code to draw a single frame</h2>
<p>The <a class="el" href="_anti_alias_8cpp.html#a50a3af67b4066f636e1dffd8d2d3c87f">renderFrame()</a> function is called continuously from the main function inside an infinite loop and it is here where we define what we want to draw.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="_anti_alias_8cpp.html#a50a3af67b4066f636e1dffd8d2d3c87f">renderFrame</a>(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="_particle_system_8cpp.html#a909e487d4dc8de5cc69bfa3c4013dd43">updateParticleAge</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUseProgram(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a43ff7599ff298b69608d6b25e899d63f">programID</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Pass particle data to the shader. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glVertexAttribPointer(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#acea29a45f77f8d4386c6a46f21529563">iLocPosition</a>, 3, GL_FLOAT, GL_FALSE, <a class="code" href="_particle_system_8cpp.html#a9021125a9bfaec02f689e4aa9586912b">PARTICLE_DATA_SIZE</a> * <span class="keyword">sizeof</span>(GLfloat), <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a09a3fa5293d52e22765fa123d1fcb070">particleData</a>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glVertexAttribPointer(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a2a26c1dd1d791cfb3967d3b910343fff">iLocVelocity</a>, 3, GL_FLOAT, GL_FALSE, <a class="code" href="_particle_system_8cpp.html#a9021125a9bfaec02f689e4aa9586912b">PARTICLE_DATA_SIZE</a> * <span class="keyword">sizeof</span>(GLfloat), &amp;<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a09a3fa5293d52e22765fa123d1fcb070">particleData</a>[3]));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glVertexAttribPointer(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a7d89b3622b7d7e3152cc98ff83c1f34a">iLocParticleTimes</a>, 3, GL_FLOAT, GL_FALSE, <a class="code" href="_particle_system_8cpp.html#a9021125a9bfaec02f689e4aa9586912b">PARTICLE_DATA_SIZE</a> * <span class="keyword">sizeof</span>(GLfloat), &amp;<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a09a3fa5293d52e22765fa123d1fcb070">particleData</a>[6]));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glEnableVertexAttribArray(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#acea29a45f77f8d4386c6a46f21529563">iLocPosition</a>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glEnableVertexAttribArray(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a2a26c1dd1d791cfb3967d3b910343fff">iLocVelocity</a>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glEnableVertexAttribArray(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a7d89b3622b7d7e3152cc98ff83c1f34a">iLocParticleTimes</a>));</div>
<div class="line"></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUniformMatrix4fv(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#abff8871ff9ca5f27e4a788b27c083544">iLocMVP</a>, 1, GL_FALSE, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a538a67a548e33663abbe01896af7f102">modelViewPerspective</a>.getAsArray()));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUniform3fv(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a75854fa76c5c2c81d908608710a60689">iLocGravity</a>, 1, (GLfloat *)&amp;<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#ae5e284865e9fbc88ec54cc9b3aa6f82c">gravity</a>));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUniform3fv(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#afbf1e13c677015e5a01e60d1abe89e25">iLocColour</a>, 1, (GLfloat *)&amp;<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#abe906bbe83e8ee0a3b0dac41b883680b">baseColour</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Bind the texture. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glActiveTexture(GL_TEXTURE0));</div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glBindTexture(GL_TEXTURE_2D, <a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#ad7ff2b2fa909dd12efa77f7e21f2f371">textureID</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Set the sampler to point at the 0th texture unit. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glUniform1i(<a class="code" href="_particle_system_8cpp.html#a5f0582e72776bd48d89ee923e1201a2e">userData</a>-&gt;<a class="code" href="struct_user_data.html#a8cd725c4a2ded36ab49d05df6d672038">iLocSampler</a>, 0));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Draw particles. */</span></div>
<div class="line">    <a class="code" href="simple__framework_2inc_2_platform_8h.html#a5d9574303c254cdd7639476d1cec8f36">GL_CHECK</a>(glDrawArrays(GL_POINTS, 0, <a class="code" href="_particle_system_8cpp.html#a75cbc112dce4b21c13fe7bb671accab1">NUM_PARTICLES</a>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Draw fonts. */</span></div>
<div class="line">    <a class="code" href="_anti_alias_8cpp.html#a40f21880bfa32eac92ee5cc4873898ef">text</a>-&gt;draw();</div>
<div class="line">}</div>
</div><!-- fragment --><p> The first instruction indicates OpenGL ES to clear the color and depth buffers with the color defined previously by means of glClearColor.</p>
<p>The next command glUseProgram tells OpenGL ES to execute in the GPU the code referenced with the handle programID.</p>
<p>The following three commands pass to the vertex shader the particle's initial position, velocity vectors and vectors containing the particle's lifetime, delay and age parameters. As all these magnitudes are kept in a unique array we must indicate in the glVertexAttribPointer command the byte offset between each consecutive set of vertex attributes. Afterwards we request OpenGL ES to enable each attribute index. If the attribute is not enabled, it will not be used during rendering.</p>
<p>Transformation matrix, gravity and particle system base color are passed to the vertex shader as uniforms.</p>
<p>A texture is also passed to the shaders as a uniform but we must first tell OpenGL ES the texture unit we want to set active and then bind the texture.</p>
<p>The next step is to tell OpenGL ES the type of primitive to render from array data. In this case we are requesting to render a primitive of point type (GL_POINTS) indicating additionally the starting index in the enabled array and the number of indices to be rendered.</p>
<p>Finally we invoke a library function to render the text previously defined.</p>
<h2><a class="anchor" id="particleSystemReleaseResources"></a>
Release allocated resources</h2>
<p>After execution all allocated resources must be released.</p>
<div class="fragment"><div class="line">    <span class="comment">/* Shut down OpenGL ES. */</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Shut down Text. */</span></div>
<div class="line">    <span class="keyword">delete</span> <a class="code" href="_anti_alias_8cpp.html#a40f21880bfa32eac92ee5cc4873898ef">text</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Shut down EGL. */</span></div>
<div class="line">    EGLRuntime::terminateEGL();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Shut down windowing system. */</span></div>
<div class="line">    platform-&gt;destroyWindow();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Shut down the Platform object. */</span></div>
<div class="line">    <span class="keyword">delete</span> platform;</div>
</div><!-- fragment --><p> The call to terminateEGL() library function releases all resources allocated when EGL was initialized.</p>
<p>Call destroyWindow() library function to destroy the platform window.</p>
<h1><a class="anchor" id="templateRunning"></a>
Running the Sample</h1>
<p>To build and run the sample please follow the instructions in the <a class="el" href="quick_start.html">Quick Start Guide</a>. This sample renders a particle system simulating smoke. You should see an output similar to: </p>
<div class="image">
<img src="particle_system.png" alt="particle_system.png"/>
<div class="caption">
Particle System sample</div></div>
 <h1><a class="anchor" id="pasMoreInformation"></a>
More Information</h1>
<p>For more information have a look at the code in <a class="el" href="_particle_system_8cpp.html">ParticleSystem.cpp</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">
        <a class="copyright" href="http://www.arm.com/">(C) ARM Ltd. 2013</a>
    </li>
  </ul>
</div>
</body>
</html>
